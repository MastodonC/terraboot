#cloud-config
output : { all : '| tee -a /var/log/cloud-init-output.log' }
package_update: true
packages:
    - openvpn
users:
    - default
      ssh-authorized-keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDAwiUsxT0KzWp6X/JRHA1/hqZSKJ9YWUOUWmvIvvJkC3S1RauRiq9Vuf98bYfzPuwyEIcJocGlcJdKslTcDoPnoulDpBCnciL3FP86oMvjM1SBGOlfAH/6KoDsp6KqgidtWyf69LAPvK8Rpvla3iDHnTuIapAnScwv2DvE+QY1XxK4fzd5CW1gAc89OdsY1lA/IizZN2T6G4cAul1VVn4HONKGujNBfMMDARr9CRhH2xA7MuTeS+NUr76Xysv+oqCU4The1tbodRItHJVv2I9Zo14fQxboWR8IaNyatRlZT+rZC0e+SGyNlxhr7PDaNjhhSU47we+UVPWXao7PC3kF elise@roc-bird.local
write_files:
    - content:  |
{{ta-key}}
      permissions: '600'
      path: /etc/openvpn/ta.key
    - content:  |
{{ca-cert}}
      permissions: '644'
      path: /etc/openvpn/ca.crt
    - content:  |
{{vpn-key}}
      permissions: '600'
      path: /etc/openvpn/mesos-vpn-gw.key
    - content:  |
{{vpn-cert}}
      permissions: '644'
      path: /etc/openvpn/mesos-vpn-gw.crt
{{crl}}
      permissions: '644'
      path: /etc/openvpn/crl.pem
    - content:  |
{{dh-param}}
      permissions: '600'
      path: /etc/openvpn/dh2048.pem
    - content: |
               port 1194
               proto udp
               dev tun
               ca ca.crt
               cert mesos-vpn-gw.crt
               key mesos-vpn-gw.key
               dh dh2048.pem
               crl-verify crl.pem
               server 10.20.0.0 255.255.255.0
               ifconfig-pool-persist ipp.txt
               push "route {{range-start}} 255.255.0.0"
               push "dhcp-option DNS {{fallback-dns}}"
               push "dhcp-option DOMAIN eu-central-1.compute.internal"
               keepalive 10 120
               tls-auth ta.key 0
               comp-lzo
               persist-key
               persist-tun
               status openvpn-status.log
               verb 3
      permissions: '644'
      path: /etc/openvpn/server.conf
    - content: |
               net.ipv4.ip_forward = 1
      permissions: '644'
      path: /etc/sysctl.d/99-ip-forwarding.conf
runcmd:
    - sysctl -p
    - sysctl -w net.ipv4.ip_forward=1
    - iptables -t nat -A POSTROUTING -s 10.20.0.0/24 -o eth0 -j MASQUERADE
    - service openvpn restart
